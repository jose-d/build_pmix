on: [push]

env:
  UPSTREAM_PATH: https://github.com/openpmix/openpmix/releases/download/v4.2.3/pmix-4.2.3-1.src.rpm
  
jobs:
  first-job:
    name: produce rpms
    runs-on: ubuntu-22.04
    container: docker://rockylinux:8
    steps:
      - name: install repos with dependencies + prereqs
        run: |
          dnf -y install epel-release
          
      - name: enable powertools
        run: |
          dnf config-manager --set-enabled powertools
          
      - name: install Development Tools
        run: |
          dnf -y group install "Development Tools"
          
      - name: update everything
        run: |
          dnf -y update
          
      - name: install dependencies
        run: |
          dnf -y install hwloc-devel wget munge-devel openssl-devel rpm-build libevent-devel python3-devel
      
      - name: download tarball from upstream repository
        run: |
          wget ${UPSTREAM_PATH}
          
      - name: build rpms
        run: |
          rpmbuild --rebuild pmix-*.src.rpm
          
      - name: upload rpm as artifact
        uses: actions/upload-artifact@v3
        with:
          name: pmix-4.2.3-1.el8.x86_64.rpm
          path: /github/home/rpmbuild/RPMS/x86_64/pmix-*.x86_64.rpm
          
# dealing with releases

      - name: Create release string from date
        id: date # we need id to be able parse the result as steps.date.outputs.date
        run: echo "::set-output name=date::$(date +'%Y%m%d_%H%M%S')"
        
      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.date.outputs.date }}
          release_name: Release ${{ steps.date.outputs.date }}
          draft: false
          prerelease: false
          
      - name: Upload release "asset"
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /artifacts/pmix-4.2.3-1.el8.x86_64.rpm
          asset_name: pmix-4.2.3-1.el8.x86_64.rpm
          asset_content_type: application/octet-stream
          
      
          
